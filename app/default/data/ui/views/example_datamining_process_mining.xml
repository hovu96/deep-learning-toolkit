<form script="plot.js">
  <label>Example for Process Mining with PM4Py</label>
  <fieldset submitButton="true">
    <input type="dropdown" token="environment">
      <label>Environment</label>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>name</fieldForValue>
      <selectFirstChoice>true</selectFirstChoice>
      <search>
        <query>| rest splunk_server=local services/dltk/environments | search connector=kubernetes | table name</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <html>
        <img src="/static/app/$env:app$/icons/mining.png" style="width:5%; height:5%; float:right;"/>
        <h1>Information on Process Mining</h1>
        <p>This example shows how you can use the python library <a href="https://pm4py.fit.fraunhofer.de/" target="_blank">PM4Py</a> - developed and maintained by the Fraunhofer Institute</p>
        <p>Please install the <a href="https://splunkbase.splunk.com/app/3767/">Force Directed App for Splunk</a> for the visual below to work.</p>
      </html>
    </panel>
  </row>
  <row depends="$fit_finalized$">
    <panel>
      <html>
        <h1>Petri Net derived from Inductive Miner</h1>
        <p>The inductive miner can help to derive the structure of processes from data, e.g. in form of a petri net or process tree. <a href="https://pm4py.fit.fraunhofer.de/documentation#item-3-2">More information.</a>
        </p>
        <div>
          <img width="100%" height="auto" id="plot_matrix" src=""/>
        </div>
      </html>
    </panel>
    <panel>
      <html>
        <h1>Graph Representation</h1>
        <p>This visualization shows all related process parts and transitions.</p>
      </html>
      <viz type="force_directed_viz.force_directed">
        <search>
          <done>
            <condition match="$job.resultCount$&gt;0">
              <set token="fit_finalized">process_mining</set>
            </condition>
            <condition>
              <unset token="fit_finalized"></unset>
            </condition>
          </done>
          <query>index=_internal uri=* user=*
| stats count by _time uri user
| eval start_timestamp=strftime(_time, "%Y%m%dT%H%M%S")
| rename uri as case:concept:name user as concept:name
| eval time:timestamp = start_timestamp
| compute algorithm="Process Miner" environment="$environment$" method="fit" fields="case:concept:name,concept:name,start_timestamp,time:timestamp" model_name="process_mining"
| rex field=0 "\((?&lt;start_type&gt;\w)\)(?&lt;src&gt;.*)-&gt;\((?&lt;dest_type&gt;\w)\)(?&lt;dest&gt;.*)"
| eventstats count by src dest
| table src dest count</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="drilldown">none</option>
        <option name="force_directed_viz.force_directed.AttractDistanceMax">200</option>
        <option name="force_directed_viz.force_directed.AttractDistanceMin">60</option>
        <option name="force_directed_viz.force_directed.AttractForceStrength">-300</option>
        <option name="force_directed_viz.force_directed.CollisionIterations">1</option>
        <option name="force_directed_viz.force_directed.CollisionRadius">30</option>
        <option name="force_directed_viz.force_directed.CollisionStrength">0.7</option>
        <option name="force_directed_viz.force_directed.ColorRange1">100</option>
        <option name="force_directed_viz.force_directed.ColorRange1Code">#65a637</option>
        <option name="force_directed_viz.force_directed.ColorRange2">500</option>
        <option name="force_directed_viz.force_directed.ColorRange2Code">#6db7c6</option>
        <option name="force_directed_viz.force_directed.ColorRange3">1000</option>
        <option name="force_directed_viz.force_directed.ColorRange3Code">#f7bc38</option>
        <option name="force_directed_viz.force_directed.ColorRange4">10000</option>
        <option name="force_directed_viz.force_directed.ColorRange4Code">#f58f39</option>
        <option name="force_directed_viz.force_directed.ColorRange5">1000000</option>
        <option name="force_directed_viz.force_directed.ColorRange5Code">#d93f3c</option>
        <option name="force_directed_viz.force_directed.ForceCollision">20</option>
        <option name="force_directed_viz.force_directed.LineColor">disabled</option>
        <option name="force_directed_viz.force_directed.LinkDistance">100</option>
        <option name="force_directed_viz.force_directed.LinkLength">1</option>
        <option name="force_directed_viz.force_directed.PanZoom">disabled</option>
        <option name="force_directed_viz.force_directed.RepelDistanceMax">50</option>
        <option name="force_directed_viz.force_directed.RepelDistanceMin">10</option>
        <option name="force_directed_viz.force_directed.RepelForceStrength">-140</option>
        <option name="force_directed_viz.force_directed.SWRange1">1</option>
        <option name="force_directed_viz.force_directed.SWRange2">1</option>
        <option name="force_directed_viz.force_directed.SWRange3">1</option>
        <option name="force_directed_viz.force_directed.SWRange4">1</option>
        <option name="force_directed_viz.force_directed.SWRange5">1</option>
        <option name="force_directed_viz.force_directed.arrows">enabled</option>
        <option name="force_directed_viz.force_directed.lowerRange">5</option>
        <option name="force_directed_viz.force_directed.nodeFontSize">10</option>
        <option name="force_directed_viz.force_directed.theme">light</option>
        <option name="force_directed_viz.force_directed.upperRange">5</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
    <panel>
      <html>
        <h1>Directly-Follows Graph (DFG)</h1>
        <p>Process models modeled using Petri nets have a well-defined semantic: a process execution starts from the places included in the initial marking and finishes at the places included in the final marking. <a href="https://pm4py.fit.fraunhofer.de/documentation#item-3-4">More information.</a>
        </p>
        <div>
          <img width="100%" height="auto" id="plot_pairplot" src=""/>
        </div>
      </html>
    </panel>
  </row>
  <row>
    <panel depends="$fit_finalized$">
      <table>
        <search>
          <query>| makeresults count=1 
| compute algorithm="Process Miner" environment="$environment$" method="summary" fields="_time" model_name="$fit_finalized$"
| spath input=summary output=plot path=model 
| eval text=split(plot,", ")
| mvexpand text
| table text
| rex field=text "\"b'(?&lt;plots&gt;.*)'\""
| rex field=text "'(?&lt;token&gt;\w+)':"
| table token plots
| transpose 0 header_field=token
| table plot_*</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
          <done>
            <condition match="$job.resultCount$&gt;0">
              <set token="plot_matrix">$result.plot_matrix$</set>
              <set token="plot_pairplot">$result.plot_pairplot$</set>
            </condition>
            <condition>
              <unset token="plot_matrix"></unset>
              <unset token="plot_pairplot"></unset>
            </condition>
          </done>
        </search>
        <option name="count">1</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>